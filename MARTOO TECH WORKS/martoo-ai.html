<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martoo AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        /* Custom scrollbar for chat messages */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Style for the typing indicator dots */
        .typing-indicator span {
            animation: blink 1s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        .btn-gradient {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-gradient:hover {
            background: linear-gradient(135deg, #66BB6A, #43A047);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        /* Ensure the main container fills the viewport height */
        .main-container {
            height: 100vh;
        }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4CAF50;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="flex main-container">
        <!-- Sidebar Menu -->
        <div class="bg-gray-800 text-gray-100 w-64 p-6 flex flex-col justify-between hidden md:flex rounded-r-lg shadow-xl">
            <div>
                <h1 class="text-3xl font-bold mb-6">Martoo AI</h1>
                <button id="new-chat-button" class="w-full text-left py-3 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-200 mb-4">
                    <i class="fas fa-plus mr-3"></i>New Chat
                </button>
                <div class="space-y-2">
                    <!-- Placeholder for chat history, to be implemented later -->
                    <a href="#" class="block py-2 px-4 rounded-lg text-gray-400 hover:bg-gray-700 transition duration-200">
                        <i class="fas fa-comment-dots mr-3"></i>Recent Chat
                    </a>
                </div>
            </div>
            <div class="text-sm text-gray-500">
                <p>Chat with Martoo AI</p>
            </div>
        </div>

        <!-- Main Chat Content -->
        <div class="flex-1 flex flex-col bg-white rounded-l-lg shadow-xl md:rounded-l-none">
            <!-- Header for the chat area -->
            <div class="bg-gray-200 p-4 border-b border-gray-300 flex justify-between items-center sticky top-0 z-10">
                <h1 class="text-xl font-bold text-gray-800 md:hidden">Martoo AI</h1>
                <div class="flex-1 flex justify-end items-center space-x-2">
                    <!-- Display loading spinner while app is initializing -->
                    <div id="loading-spinner" class="spinner"></div>
                    <span id="user-id-display" class="bg-gray-300 text-gray-600 px-3 py-1 rounded-full text-xs">Connecting...</span>
                </div>
            </div>

            <!-- Chat messages container -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
                <div id="initial-message" class="text-center text-gray-400 mt-10">
                    <i class="fas fa-robot text-6xl mb-4 text-gray-400"></i>
                    <p class="text-lg font-semibold mb-2">Welcome to Martoo AI Assistant!</p>
                    <p class="mb-4">Start a new chat or select an existing one from the sidebar.</p>
                </div>
            </div>

            <div id="typing-indicator" class="hidden text-gray-500 text-sm px-6 pb-2 typing-indicator">
                Martoo AI is typing<span>.</span><span>.</span><span>.</span>
            </div>

            <!-- Chat input area -->
            <div id="chat-input-area" class="bg-gray-100 p-4 border-t border-gray-200 flex items-end space-x-3 sticky bottom-0 w-full z-10 hidden">
                <label for="image-upload" class="cursor-pointer text-gray-600 hover:text-blue-500 transition duration-200 p-2 rounded-full bg-gray-200 hover:bg-gray-300">
                    <i class="fas fa-image text-xl"></i>
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                </label>
                <textarea id="chat-input" rows="1" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 resize-none overflow-y-hidden" placeholder="Type your message..."></textarea>
                <button id="send-button" class="btn-gradient text-white px-6 py-3 rounded-full text-lg font-semibold transition duration-200">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Import Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants and global variables
        const CHAT_COLLECTION_NAME = 'chats';

        // Get DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const imageUpload = document.getElementById('image-upload');
        const chatInputArea = document.getElementById('chat-input-area');
        const initialMessage = document.getElementById('initial-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const typingIndicator = document.getElementById('typing-indicator');

        // Initialize Firebase services
        let db;
        let auth;
        let userId;

        // Securely retrieve Firebase config and app ID from the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const geminiAPIKey = typeof __api_key !== 'undefined' ? __api_key : '';

        // Function to create a chat message element
        function createChatMessage(data, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = `max-w-md px-4 py-2 rounded-lg shadow-md ${isUser ? 'bg-green-400 text-white' : 'bg-white text-gray-800'}`;

            if (data.text) {
                const textParagraph = document.createElement('p');
                textParagraph.textContent = data.text;
                messageContentDiv.appendChild(textParagraph);
            }

            if (data.imageUrl) {
                const image = document.createElement('img');
                image.src = data.imageUrl;
                image.className = "mt-2 rounded-md max-w-full h-auto";
                messageContentDiv.appendChild(image);
            }

            // Optional timestamp for messages
            const timestampSpan = document.createElement('span');
            const date = data.timestamp ? new Date(data.timestamp.seconds * 1000) : new Date();
            timestampSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            timestampSpan.className = `text-xs mt-1 ${isUser ? 'text-green-200' : 'text-gray-400'} block`;
            messageContentDiv.appendChild(timestampSpan);

            messageDiv.appendChild(messageContentDiv);
            return messageDiv;
        }

        // Function to handle Firebase initialization and authentication
        async function setupFirebase() {
            try {
                // Initialize Firebase app
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in the user. This is crucial for accessing Firestore.
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Get the user's ID and display it
                userId = auth.currentUser?.uid || crypto.randomUUID();
                userIdDisplay.textContent = `User ID: ${userId}`;
                chatInputArea.classList.remove('hidden');
                loadingSpinner.style.display = 'none'; // Hide the spinner

                // Start listening for real-time updates to the chat
                listenForChatMessages();

            } catch (error) {
                console.error("Firebase setup failed:", error);
                userIdDisplay.textContent = 'Connection failed';
                loadingSpinner.style.display = 'none';
            }
        }

        // Function to call the AI backend and get a response
        async function getAIResponse(prompt) {
            typingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiAPIKey}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "You are a helpful AI assistant. Answer user queries concisely." }]
                    }
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't generate a response.";
                
                // Add the AI's response to Firestore
                await addDoc(collection(db, 'artifacts', appId, 'public/data', CHAT_COLLECTION_NAME), {
                    userId: "Martoo AI", // Unique ID for the AI
                    text: text,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error getting AI response:", error);
                // Add an error message to the chat
                 await addDoc(collection(db, 'artifacts', appId, 'public/data', CHAT_COLLECTION_NAME), {
                    userId: "Martoo AI",
                    text: "Sorry, I'm having trouble connecting right now. Please try again later.",
                    timestamp: serverTimestamp()
                });
            } finally {
                typingIndicator.classList.add('hidden');
            }
        }


        // Function to send a message to Firestore and trigger AI response
        async function sendMessage() {
            const messageText = chatInput.value.trim();
            const imageFile = imageUpload.files[0];

            if (!messageText && !imageFile) {
                return;
            }

            try {
                // Add the user's message to Firestore first
                await addDoc(collection(db, 'artifacts', appId, 'public/data', CHAT_COLLECTION_NAME), {
                    userId: userId,
                    text: messageText,
                    timestamp: serverTimestamp()
                });

                // Clear the input field and reset height
                chatInput.value = '';
                imageUpload.value = '';
                chatInput.style.height = 'auto';

                // Now, call the AI backend with the user's message
                getAIResponse(messageText);

            } catch (error) {
                console.error("Error writing message to Firestore: ", error);
            }
        }

        // Real-time listener for chat messages
        function listenForChatMessages() {
            const messagesRef = collection(db, 'artifacts', appId, 'public/data', CHAT_COLLECTION_NAME);
            const q = query(messagesRef, orderBy('timestamp'));

            onSnapshot(q, (snapshot) => {
                // Clear the chat and initial message
                chatMessages.innerHTML = '';
                initialMessage.style.display = 'none';

                snapshot.forEach((doc) => {
                    const messageData = doc.data();
                    const isUser = messageData.userId === userId;
                    const messageElement = createChatMessage(messageData, isUser);
                    chatMessages.appendChild(messageElement);
                });

                // Scroll to the bottom after new messages are loaded
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
        
        // Event listeners for the UI
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-resize the textarea
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = chatInput.scrollHeight + 'px';
        });

        // Initialize the app on window load
        window.addEventListener('load', setupFirebase);
    </script>
</body>
</html>
